PREFIX xyz: <http://sparql.xyz/facade-x/data/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX fx: <http://sparql.xyz/facade-x/ns/>
PREFIX example: <http://example/ns/>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX stix: <http://docs.oasis-open.org/cti/ns/stix#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX vuln: <http://www.cve.org/ontology/vulnerability#>
PREFIX cwe: <http://cwe.mitre.org/ns/cwe#>

CONSTRUCT {

	<http://hohimer.net/output-kg>
		a owl:Ontology ;
		owl:imports
			<http://docs.oasis-open.org/tac/ns/tac>,
			<http://www.cve.org/ontology/vulnerability>
			;
		.

											 
	?cve_record_iri a vuln:CveRecord .
	?cve_record_iri vuln:dataType ?dataType .
	?cve_record_iri vuln:dataVersion ?dataVersion .	
	?cve_record_iri vuln:cveMetadata  ?cve_metadata_iri .
	?cve_record_iri vuln:cnaContainer ?cna_container_iri .
	?cve_record_iri vuln:cve ?cve_iri .
	?cve_iri a vuln:Vulnerability .

	?cve_metadata_iri a vuln:CveMetadata .
	?cve_metadata_iri vuln:cveId ?cveId .
	?cve_metadata_iri vuln:assignerOrgId ?assignerOrgId .
	?cve_metadata_iri vuln:assignerShortName ?assignerShortName .
	?cve_metadata_iri vuln:requesterUserId ?requesterUserId .
	?cve_metadata_iri vuln:serial ?serial .
	?cve_metadata_iri vuln:state ?state .

	?cna_container_iri a vuln:CnaContainer .
	?cna_container_iri vuln:title ?title .
	?cna_container_iri vuln:datePublic ?datePublic .
	?cna_container_iri vuln:dateAssigned ?dateAssigned .
	?cna_container_iri vuln:providerMetadata ?provider_metadata_iri .
	?cna_container_iri vuln:problemType ?problem_type_iri .
	?cna_container_iri vuln:description ?desc_iri .
	?cna_container_iri vuln:affected ?affected_asset_iri .
	
	?affected_asset_iri a vuln:AffectedAsset .
	?affected_asset_iri vuln:product ?affectedProduct .
	?affected_asset_iri vuln:vendor ?affectedProductVendor .
	?affected_asset_iri vuln:packageName ?affectedPackageName .
	?affected_asset_iri vuln:version ?version_iri .
	?affected_asset_iri vuln:cpe ?acpe .
	?affected_asset_iri vuln:defaultStatus ?affectedDefaultStatus .
	
	?version_iri a vuln:Version .
	?version_iri vuln:status ?verStatus .
	?version_iri vuln:versionString ?versionString .
	
	
	?desc_iri a vuln:Description .
	?desc_iri vuln:value ?des_value .
	?desc_iri vuln:lang ?des_lang .
	
	?provider_metadata_iri a vuln:ProviderMetadata .
	?provider_metadata_iri vuln:orgId ?orgId .
	?provider_metadata_iri vuln:shortName ?shortName .
	?provider_metadata_iri vuln:dateUpdated ?dateUpdated .
	
	?problem_type_iri a vuln:ProblemType .
	?problem_type_iri vuln:problemTypeDescription ?problem_type_desc_iri .
	
	?problem_type_desc_iri a vuln:ProblemTypeDescription .
		?problem_type_desc_iri vuln:lang ?ptdLang .
		?problem_type_desc_iri vuln:cweId ?cweID .
		?problem_type_desc_iri vuln:description ?ptdDescription .
		?problem_type_desc_iri vuln:type ?description_type .
		?problem_type_desc_iri vuln:weakness ?cwe_iri .
		?cwe_iri a cwe:Weakness .
	
	vuln:dataType a owl:DatatypeProperty .
	vuln:dataVersion a owl:DatatypeProperty .
	vuln:assignerShortName a owl:DatatypeProperty .
	vuln:requesterUserId a owl:DatatypeProperty .
	vuln:serial a owl:DatatypeProperty .
	vuln:state a owl:DatatypeProperty .
	vuln:title a owl:DatatypeProperty .
	vuln:datePublic a owl:DatatypeProperty .
	vuln:orgId a owl:DatatypeProperty .
	vuln:shortName a owl:DatatypeProperty .
	vuln:dateUpdated a owl:DatatypeProperty .
	vuln:description a owl:DatatypeProperty .
	vuln:lang a owl:DatatypeProperty .
	vuln:type a owl:DatatypeProperty .
	vuln:value a owl:DatatypeProperty .
	vuln:status a owl:DatatypeProperty .
	vuln:versionString a owl:DatatypeProperty .
	vuln:vendor a owl:DatatypeProperty .
	vuln:product a owl:DatatypeProperty .
	vuln:cpe a owl:DatatypeProperty .
	vuln:packageName a owl:DatatypeProperty .
	vuln:defaultStatus a owl:DatatypeProperty .
	vuln:cveId a owl:DatatypeProperty .
	
	vuln:cveMetadata a owl:ObjectProperty .
	vuln:providerMetadata a owl:ObjectProperty .
	vuln:cnaContainer a owl:ObjectProperty .
	vuln:problemTypeDescription a owl:ObjectProperty .
	vuln:problemType a owl:ObjectProperty .
	vuln:description a owl:ObjectProperty .
	vuln:version a owl:ObjectProperty .
	vuln:affected a owl:ObjectProperty .
	vuln:weakness a owl:ObjectProperty .
	vuln:cve a owl:ObjectProperty .
}
WHERE {
	SERVICE <x-sparql-anything:blank-nodes=false> {
		# fx:properties fx:location "data/input/my-input.json" .
		fx:properties fx:location "__PATH__" .
#		fx:properties fx:location "data/input/2023/51xxx/CVE-2023-51812.json" .
	# CVE Record root of json
	?root xyz:dataType ?dataType .
	OPTIONAL { ?root xyz:dataVersion ?dataVersion . }
	?root xyz:cveMetadata ?cveMetadata .

	# CVE Metadata Object
	?cveMetadata xyz:cveId ?cveId .
	OPTIONAL {
		?cveMetadata xyz:assignerOrgId ?assignerOrgId .
		?cveMetadata xyz:assignerShortName ?assignerShortName .
		?cveMetadata xyz:requesterUserId ?requesterUserId .
		?cveMetadata xyz:serial ?serial .
		?cveMetadata xyz:state ?state .
	}
	
	# root array of CNA Containers
		?root xyz:containers ?cnaContainers .

	# a single container from the containers array
		?cnaContainers xyz:cna ?aContainer .
		?cnaContainers ?container_slot ?aContainer .
		OPTIONAL {?aContainer xyz:datePublic ?datePublic .} 
		OPTIONAL {?aContainer xyz:title ?title .} 
		OPTIONAL {?aContainer xyz:dateAssigned ?dateAssigned .} 
		OPTIONAL {
			?aContainer xyz:descriptions ?descripts .
			?descripts ?descript_slot ?aDescription .
				OPTIONAL { ?aDescription xyz:lang ?des_lang . }
				OPTIONAL { ?aDescription xyz:value ?des_value . }		
		}
		
	# Get the AffectedAsset of the CnaContainer
		OPTIONAL { 
			?aContainer xyz:affected ?affected .
			?affected ?prod_slot ?anAffectedAsset .
			?anAffectedAsset xyz:product ?affectedProduct . 
			?anAffectedAsset xyz:vendor ?affectedProductVendor .
			?anAffectedAsset xyz:packageName ?affectedPackageName .
			?anAffectedAsset xyz:defaultStatus ?affectedDefaultStatus .
			OPTIONAL {?anAffectedAsset xyz:versions ?aVersion . 
				?aVersion ?ver_slot ?aVer .
				?aVer xyz:status ?verStatus . 
				?aVer xyz:version ?versionString .
			}
			OPTIONAL {?anAffectedAsset xyz:cpes ?aCpe .
				?aCpe ?cpe_slot ?acpe .
			}
		}	


	# Get the provider metadata from the container
		?aContainer xyz:providerMetadata ?providerMetadata .
		OPTIONAL { 
			?providerMetadata xyz:orgId ?orgId .
			?providerMetadata xyz:shortName ?shortName .
			?providerMetadata xyz:dateUpdated ?dateUpdated .
		}	
	



	# Get the problem types from the container
		?aContainer xyz:problemTypes ?problemTypes .
		?problemTypes ?probType_slot ?problemType .
		OPTIONAL { 
			?problemType xyz:descriptions ?probTypeDescriptions . 
			?probTypeDescriptions ?description_slot ?pTDescription .
				OPTIONAL { ?pTDescription xyz:lang ?ptdLang . }
				OPTIONAL { ?pTDescription xyz:cweId ?cweID . }
				OPTIONAL { ?pTDescription xyz:description ?ptdDescription . }
				OPTIONAL { ?pTDescription xyz:type ?description_type . }
		}


	}  ##### End of SERVICE block ##############

	# Generate the CVE Record IRI	
	 BIND( IF(?dataType = "CVE_RECORD", (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#CveRecord-", ?cveId  ))), ?nothing ) AS ?cve_record_iri ) .

	# Generate the CVE Metadata IRI	
	 BIND( IF(BOUND(?cveId), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#", ?cveId  ))), ?nothing ) AS ?cve_iri ) .

	# Generate the CVE Metadata IRI	
	 BIND( IF(BOUND(?cveId), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#CveMetadata-", ?cveId  ))), ?nothing ) AS ?cve_metadata_iri ) .

	# Generate the CNA Container IRI	
	 BIND( IF(BOUND(?aContainer), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#CnaContainer-", ?cveId  ))), ?nothing ) AS ?cna_container_iri ) .

	# Generate the Provider Metadata object IRI	
	 BIND( IF(BOUND(?providerMetadata), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#ProviderMetadata-", ?cveId  ))), ?nothing ) AS ?provider_metadata_iri ) .

	# Generate the Problem Type object IRI	
	 BIND( IF(BOUND(?problemType), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#ProblemType-", ?cveId  ))), ?nothing ) AS ?problem_type_iri ) .

	# Generate the Problem Type Description object IRI	
	 BIND( IF(BOUND(?pTDescription), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#ProblemTypeDescription-", STRUUID()  ))), ?nothing ) AS ?problem_type_desc_iri ) .

	# Generate the Description object IRI	
	 BIND( IF(BOUND(?descripts), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#Description-", STRUUID()  ))), ?nothing ) AS ?desc_iri ) .

	# Generate the CWE ID object IRI	
	 BIND( IF(BOUND(?cweID), (IRI(CONCAT("http://cwe.mitre.org/ns/cwe#", ?cweID  ))), ?nothing ) AS ?cwe_iri ) .

	# Generate the ProductVersion object IRI	
	 BIND( IF(BOUND(?affected), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#AffectedAsset-", STRUUID()  ))), ?nothing ) AS ?affected_asset_iri ) .


	# Generate the Version object IRI	
	 BIND( IF(BOUND(?aVersion), (IRI(CONCAT("http://www.cve.org/ontology/vulnerability#Version-", STRUUID()  ))), ?nothing ) AS ?version_iri ) .

}
